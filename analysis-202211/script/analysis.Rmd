---
title: "analysis"
output: html_document
date: "2022-11-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '../') # run getwd()
# 
# # setup
# packages = c("tidyverse", "ggplot2", "dplyr", "RColorBrewer", "irr", 'readr', 'readxl')
# 
# package.check <- lapply(
#   packages,
#   FUN = function(x) {
#     if (!require(x, character.only = TRUE)) {
#       install.packages(x, dependencies = TRUE)
#       library(x, character.only = TRUE)
#     }
#   }
# )

#install.packages("irr")
library("tidyr")
library("dbplyr")
library("ggplot2")
library("dplyr")
library("RColorBrewer")
library("irr")
library('readxl')
library("boot")
library("Hmisc")
#install.packages('stringi')
#install.packages('Hmisc')


# ggplot theme
theme_set(theme_light())
```

```{r}
pre <- read_excel("../data/data.xlsx", sheet = "Pre")
post <- read_excel("../data/data.xlsx", sheet = "Post")

pre <- subset(pre, id!=20)
post <- subset(post, id!=20)

pre2 <- subset(pre, select = -c(pre_2))


```

```{r}
pre2 <- gather(pre2, key="question", value="val", 7:13)
post2 <- gather(post, key="question", value="val", 3:10)

pre_question_ids <- unique(pre2$question)

post_question_ids <- unique(post2$question)

pre2 <- pre2[,c("id", "study_type", "question", "val")]
post2 <- post2[,c("id", "study_type", "question", "val")]

df <- rbind(pre2, post2)

```



```{r}
df %>% 
  ggplot(aes(x=study_type, y = val, color= study_type)) +
    xlab("") + ylab("mean answer scale")+
    ggtitle("95% CI for mean")+
    stat_summary(fun.data = "mean_cl_boot", size = 0.5, position = position_nudge(x=0.00, y=0), alpha=1) +
  coord_flip() +
    facet_wrap(.~question)
```

```{r}
# t.test(df$groundtruth2, conf.level = 0.95)
# t.test(filter(df, question == 'pre_1', ques == 'pre_1')$val, conf.level = 0.95)

library(boot)
library(effsize)

compute_ci = function (qname, c1, c2) {
  #result = data.frame(qname=qname, t=c(), W=c(), d=c())
#  filter(df, question == )
  t = t.test(
    pre_1_c,
    pre_1_h,
    conf.level=.95
  )
  
  c = cohen.d(pre_1_c, pre_1_h, paired=FALSE)

  W = wilcox.test(x=pre_1_c, y=pre_1_h, na.rm=TRUE, paired=FALSE, exact=FALSE, conf.int=TRUE)

  result = data.frame(qname=c(qname), t=c(t$p.value), W=c(W[1]$statistic), d=c(c[3]$estimate))
  return(result)
}

pre_1_c <- filter(df, question == 'post_5', study_type == 'control')$val
pre_1_h <- filter(df, question == 'post_5', study_type == 'hololens')$val

compute_ci("PRE1", pre_1_c, pre_1_h)

```




